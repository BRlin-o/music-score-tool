import{c as R,r,j as e,Z as z,S as P,U as O,I,T as V,L as B,X as F,D as A,a as q}from"./zap-BOniZveP.js";import{H,A as _}from"./history-BQ_cf9TD.js";import{S as G}from"./sliders-vertical-Doc1KZGf.js";const X=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M12 3v18",key:"108xh3"}]],W=R("columns-2",X);const Z=[["path",{d:"M12 22a7 7 0 0 0 7-7c0-2-1-3.9-3-5.5s-3.5-4-4-6.5c-.5 2.5-2 4.9-4 6.5C6 11.1 5 13 5 15a7 7 0 0 0 7 7z",key:"c7niix"}]],Q=R("droplet",Z);const J=[["rect",{width:"18",height:"7",x:"3",y:"3",rx:"1",key:"f1a2em"}],["rect",{width:"9",height:"7",x:"3",y:"14",rx:"1",key:"jqznyg"}],["rect",{width:"5",height:"7",x:"16",y:"14",rx:"1",key:"q5h2i8"}]],K=R("layout-template",J);const Y=[["path",{d:"M3 7V5a2 2 0 0 1 2-2h2",key:"aa7l1z"}],["path",{d:"M17 3h2a2 2 0 0 1 2 2v2",key:"4qcy5o"}],["path",{d:"M21 17v2a2 2 0 0 1-2 2h-2",key:"6vwrx8"}],["path",{d:"M7 21H5a2 2 0 0 1-2-2v-2",key:"ioqczr"}],["path",{d:"M7 12h10",key:"b7w52i"}]],ee=R("scan-line",Y);const se=[["path",{d:"M12 4v16",key:"1654pz"}],["path",{d:"M4 7V5a1 1 0 0 1 1-1h14a1 1 0 0 1 1 1v2",key:"e0r10z"}],["path",{d:"M9 20h6",key:"s66wpe"}]],te=R("type",se),d={defaults:{algorithm:"adaptive",threshold:{adaptive:60,classic:130},contrastBoost:15,scaleMultiplier:1.5,smoothness:15},ranges:{scale:{min:1,max:3,step:.5},threshold:{adaptive:{min:0,max:100},classic:{min:50,max:220}},contrastBoost:{min:0,max:60},smoothness:{min:0,max:20}}},D=async(E,N)=>new Promise((a,o)=>{const l=new Image;l.crossOrigin="Anonymous",l.onload=()=>{try{const{algorithm:y,threshold:u,contrastBoost:j,scaleMultiplier:p,smoothness:k=0}=N,x=l.width,m=x*p,f=m/x,U=l.height*f,S=document.createElement("canvas");S.width=m,S.height=U;const C=S.getContext("2d");if(!C)throw new Error("Could not get canvas context");C.imageSmoothingEnabled=!0,C.imageSmoothingQuality="high",C.drawImage(l,0,0,m,U);const L=C.getImageData(0,0,m,U),g=L.data,$=(w,i,v)=>{if(v===0)return w<i?0:255;const s=i-v,t=i+v;return w<=s?0:w>=t?255:(w-s)/(t-s)*255};if(y==="adaptive"){const w=document.createElement("canvas");w.width=m,w.height=U;const i=w.getContext("2d");if(!i)throw new Error("Could not get blur canvas context");const v=20*p;i.filter=`blur(${v}px)`,i.drawImage(S,0,0),i.clearRect(0,0,m,U),i.drawImage(l,0,0,m,U);const s=i.getImageData(0,0,m,U).data;for(let t=0;t<g.length;t+=4){const n=g[t],c=s[t],h=(100-u)/2,b=c-h,M=$(n,b,k);g[t]=M,g[t+1]=M,g[t+2]=M}}else{const w=j/100;for(let i=0;i<g.length;i+=4){let v=g[i];v<u+40&&(v=v*(1-w));const s=$(v,u,k);g[i]=s,g[i+1]=s,g[i+2]=s}}C.putImageData(L,0,0),a(S.toDataURL("image/png"))}catch(y){o(y)}},l.onerror=y=>o(y),l.src=E}),ae=({originalUrl:E,processedUrl:N,settings:a,viewMode:o})=>{const[l,y]=r.useState(50),u=r.useRef(null),j=r.useRef(!1),p=r.useCallback(k=>{if(!u.current)return;const x=u.current.getBoundingClientRect(),m=Math.max(0,Math.min(k-x.left,x.width));y(m/x.width*100)},[]);return r.useEffect(()=>{const k=()=>j.current=!1,x=f=>{j.current&&p(f.clientX)},m=f=>{j.current&&p(f.touches[0].clientX)};return window.addEventListener("mouseup",k),window.addEventListener("mousemove",x),window.addEventListener("touchmove",m,{passive:!1}),()=>{window.removeEventListener("mouseup",k),window.removeEventListener("mousemove",x),window.removeEventListener("touchmove",m)}},[p]),E?e.jsx("div",{className:"relative w-full h-full flex items-center justify-center bg-slate-200/50 select-none p-4",children:e.jsxs("div",{ref:u,className:"relative shadow-2xl bg-white max-w-full max-h-full",onMouseDown:()=>o==="split"&&(j.current=!0),onTouchStart:()=>o==="split"&&(j.current=!0),children:[e.jsx("img",{src:E,alt:"Original",className:`block max-w-full max-h-[85vh] object-contain pointer-events-none ${o==="processed"?"opacity-0":""}`}),N&&(o==="split"||o==="processed")&&e.jsx("img",{src:N,alt:"Processed",className:"absolute inset-0 w-full h-full object-contain pointer-events-none bg-white",style:{clipPath:o==="split"?`inset(0 ${100-l}% 0 0)`:"none"}}),o==="split"&&e.jsx("div",{className:"absolute inset-y-0 w-1 bg-indigo-500 cursor-ew-resize z-20 hover:bg-indigo-400 shadow-[0_0_10px_rgba(0,0,0,0.5)]",style:{left:`${l}%`},children:e.jsx("div",{className:"absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-8 h-8 bg-indigo-600 rounded-full flex items-center justify-center shadow-lg border-2 border-white text-white",children:e.jsx(_,{className:"w-4 h-4"})})}),(o==="split"||o==="processed")&&e.jsxs("div",{className:"absolute top-4 left-4 bg-black/70 text-white text-xs px-2 py-1 rounded backdrop-blur-md z-10 pointer-events-none border border-white/10",children:["處理後 (Processed) ",a?.scaleMultiplier>1&&e.jsxs("span",{className:"text-amber-300 font-bold ml-1",children:[a.scaleMultiplier,"x"]})]}),(o==="split"||o==="original")&&e.jsx("div",{className:"absolute top-4 right-4 bg-black/70 text-white text-xs px-2 py-1 rounded backdrop-blur-md z-10 pointer-events-none border border-white/10",children:"原始 (Original)"})]})}):null},le=()=>{const[E,N]=r.useState([]),[a,o]=r.useState(null),[l,y]=r.useState(d.defaults.algorithm),[u,j]=r.useState(d.defaults.threshold.adaptive),[p,k]=r.useState(d.defaults.contrastBoost),[x,m]=r.useState(d.defaults.scaleMultiplier),[f,U]=r.useState(d.defaults.smoothness),[S,C]=r.useState("split"),L=r.useRef({algorithm:l,threshold:u,contrastBoost:p,scaleMultiplier:x,smoothness:f});r.useEffect(()=>{L.current={algorithm:l,threshold:u,contrastBoost:p,scaleMultiplier:x,smoothness:f}},[l,u,p,x,f]);const g=r.useRef(null);r.useEffect(()=>{if(a&&a.settingsUsed){const s=a.settingsUsed;y(t=>t!==s.algorithm?s.algorithm:t),j(t=>t!==s.threshold?s.threshold:t),k(t=>t!==s.contrastBoost?s.contrastBoost:t),m(t=>t!==s.scaleMultiplier?s.scaleMultiplier:t),U(t=>t!==(s.smoothness??0)?s.smoothness??0:t)}},[a?.id]),r.useEffect(()=>{if(!a)return;const s={algorithm:l,threshold:u,contrastBoost:p,scaleMultiplier:x,smoothness:f};if(!(a.settingsUsed.algorithm===s.algorithm&&a.settingsUsed.threshold===s.threshold&&a.settingsUsed.contrastBoost===s.contrastBoost&&a.settingsUsed.scaleMultiplier===s.scaleMultiplier&&a.settingsUsed.smoothness===s.smoothness))return g.current&&clearTimeout(g.current),g.current=setTimeout(async()=>{try{const n=await D(a.originalUrl,s);o(c=>!c||c.id!==a.id?c:{...c,processedUrl:n,settingsUsed:s,status:"done"}),N(c=>c.map(h=>h.id===a.id?{...h,processedUrl:n,settingsUsed:s,status:"done"}:h))}catch(n){console.error("Live preview failed:",n)}},300),()=>{g.current&&clearTimeout(g.current)}},[l,u,p,x,f]);const $=r.useCallback(async s=>{if(s.length===0)return;const t=s.map(n=>({id:Math.random().toString(36).substr(2,9),name:n.name.split(".")[0]||"Image",originalUrl:URL.createObjectURL(n),processedUrl:null,status:"processing",timestamp:new Date,settingsUsed:{...L.current}}));N(n=>[...t,...n]),t.length>0&&o(t[0]),t.forEach(async n=>{try{const c=await D(n.originalUrl,n.settingsUsed);N(h=>h.map(b=>b.id===n.id?{...b,processedUrl:c,status:"done"}:b)),o(h=>h&&h.id===n.id?{...n,processedUrl:c,status:"done"}:h)}catch(c){console.error("Processing failed:",c),N(h=>h.map(b=>b.id===n.id?{...b,status:"error"}:b))}})},[]),w=s=>{s.target.files&&($(Array.from(s.target.files)),s.target.value="")};r.useEffect(()=>{const s=t=>{const n=t;if(!n.clipboardData)return;const c=n.clipboardData.items,h=[];for(let b=0;b<c.length;b++)if(c[b].type.indexOf("image")!==-1){const M=c[b].getAsFile();if(M){const T=new File([M],`Paste_${new Date().toLocaleTimeString("en-GB").replace(/:/g,"")}.png`,{type:M.type});h.push(T)}}h.length>0&&$(h)};return window.addEventListener("paste",s),()=>window.removeEventListener("paste",s)},[$]);const i=s=>{if(!s||!s.processedUrl)return;const t=document.createElement("a");t.href=s.processedUrl,t.download=`${s.name}_${s.settingsUsed.algorithm}.png`,document.body.appendChild(t),t.click(),document.body.removeChild(t)},v=(s,t)=>{t.stopPropagation(),N(n=>n.filter(c=>c.id!==s)),a?.id===s&&o(null)};return r.useEffect(()=>{j(l==="adaptive"?d.defaults.threshold.adaptive:d.defaults.threshold.classic)},[l]),e.jsxs("div",{className:"h-screen bg-slate-100 text-slate-800 font-sans flex flex-col md:flex-row overflow-hidden",children:[e.jsxs("div",{className:"w-full md:w-80 lg:w-96 bg-white border-r border-slate-200 flex flex-col h-[45vh] md:h-full z-10 shadow-xl",children:[e.jsx("div",{className:"p-4 border-b border-slate-100 bg-slate-50",children:e.jsxs("h1",{className:"text-xl font-bold text-slate-900 flex items-center gap-2",children:[e.jsx(H,{className:"w-6 h-6 text-indigo-600"}),"樂譜工作站 ",e.jsx("span",{className:"text-[10px] bg-indigo-100 text-indigo-700 px-1 rounded border border-indigo-200",children:"PRO V3"})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto custom-scrollbar bg-slate-50",children:[e.jsxs("div",{className:"p-4 border-b border-slate-200 bg-white",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3 text-slate-700",children:[e.jsx(ee,{className:"w-4 h-4 text-indigo-500"}),e.jsx("span",{className:"text-sm font-bold",children:"重建解析度 (Scale)"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("span",{className:"text-xs font-mono w-8 text-right",children:[x,"x"]}),e.jsx("input",{type:"range",min:d.ranges.scale.min,max:d.ranges.scale.max,step:d.ranges.scale.step,value:x,onChange:s=>m(Number(s.target.value)),className:"flex-1 h-2 bg-slate-200 rounded-lg accent-indigo-600 cursor-pointer"})]}),e.jsx("p",{className:"text-[10px] text-slate-400 mt-2 text-right",children:"數值越高邊緣越圓潤，但速度較慢"})]}),e.jsxs("div",{className:"p-4 border-b border-slate-200 bg-white",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3 text-slate-700",children:[e.jsx(z,{className:"w-4 h-4 text-amber-500"}),e.jsx("span",{className:"text-sm font-bold",children:"處理演算法"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("button",{onClick:()=>y("adaptive"),className:`p-2 rounded-lg text-xs font-bold border transition-all flex flex-col items-center gap-1
                                ${l==="adaptive"?"bg-amber-50 border-amber-400 text-amber-800":"bg-slate-50 border-slate-200 text-slate-500 hover:bg-slate-100"}
                            `,children:[e.jsx(P,{className:"w-4 h-4"}),"自適應 (抗陰影)"]}),e.jsxs("button",{onClick:()=>y("classic"),className:`p-2 rounded-lg text-xs font-bold border transition-all flex flex-col items-center gap-1
                                ${l==="classic"?"bg-indigo-50 border-indigo-400 text-indigo-800":"bg-slate-50 border-slate-200 text-slate-500 hover:bg-slate-100"}
                            `,children:[e.jsx(te,{className:"w-4 h-4"}),"經典 (紅光濾鏡)"]})]}),e.jsx("p",{className:"text-[10px] text-slate-500 mt-2 leading-relaxed",children:l==="adaptive"?"推薦！根據局部光線自動調整，完美去除陰影與紙張皺褶，保留細節。":"適合光線均勻的截圖，能強力去除有色游標。"})]}),e.jsxs("div",{className:"p-4 bg-white",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4 text-slate-700",children:[e.jsx(G,{className:"w-4 h-4 text-slate-500"}),e.jsx("span",{className:"text-sm font-bold",children:"參數微調"})]}),e.jsxs("div",{className:"space-y-5",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("label",{className:"text-xs font-bold text-slate-600",children:l==="adaptive"?"線條靈敏度 (Sensitivity)":"黑白閾值 (Threshold)"}),e.jsx("span",{className:"text-xs font-mono text-indigo-600",children:u})]}),e.jsx("input",{type:"range",min:l==="adaptive"?d.ranges.threshold.adaptive.min:d.ranges.threshold.classic.min,max:l==="adaptive"?d.ranges.threshold.adaptive.max:d.ranges.threshold.classic.max,value:u,onChange:s=>j(Number(s.target.value)),className:"w-full h-1.5 bg-slate-200 rounded-lg accent-indigo-600"}),e.jsx("p",{className:"text-[10px] text-slate-400",children:l==="adaptive"?"越高線條越粗，越低越乾淨":"調整黑白分界點"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("label",{className:"text-xs font-bold text-slate-600 flex items-center gap-1",children:[e.jsx(Q,{className:"w-3 h-3 text-cyan-500"}),"邊緣柔化 (Smoothness)"]}),e.jsx("span",{className:"text-xs font-mono text-indigo-600",children:f})]}),e.jsx("input",{type:"range",min:d.ranges.smoothness.min,max:d.ranges.smoothness.max,value:f,onChange:s=>U(Number(s.target.value)),className:"w-full h-1.5 bg-slate-200 rounded-lg accent-cyan-600"}),e.jsx("p",{className:"text-[10px] text-slate-400",children:"數值越高邊緣越平滑，可消除鋸齒感"})]}),l==="classic"&&e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("label",{className:"text-xs font-bold text-slate-600",children:"墨色加深"}),e.jsxs("span",{className:"text-xs font-mono text-indigo-600",children:[p,"%"]})]}),e.jsx("input",{type:"range",min:d.ranges.contrastBoost.min,max:d.ranges.contrastBoost.max,value:p,onChange:s=>k(Number(s.target.value)),className:"w-full h-1.5 bg-slate-200 rounded-lg accent-indigo-600"})]})]})]}),e.jsx("div",{className:"p-4",children:e.jsxs("label",{className:"flex flex-col items-center justify-center w-full h-16 border-2 border-dashed border-indigo-200 rounded-xl cursor-pointer bg-indigo-50/50 hover:bg-indigo-50 transition-colors group",children:[e.jsxs("div",{className:"flex items-center gap-2 text-indigo-400 group-hover:text-indigo-600",children:[e.jsx(O,{className:"w-5 h-5"}),e.jsx("span",{className:"text-xs font-bold",children:"上傳 / 貼上圖片"})]}),e.jsx("input",{type:"file",className:"hidden",accept:"image/jpeg, image/png",multiple:!0,onChange:w})]})})]}),e.jsxs("div",{className:"h-48 border-t border-slate-200 bg-slate-50 flex flex-col",children:[e.jsxs("div",{className:"p-2 border-b border-slate-100 flex justify-between items-center bg-white",children:[e.jsxs("span",{className:"text-xs font-bold text-slate-500 flex items-center gap-1",children:[e.jsx(I,{className:"w-3 h-3"})," 歷史 (",E.length,")"]}),E.length>0&&e.jsx("button",{onClick:()=>N([]),className:"text-slate-400 hover:text-red-500 p-1 rounded hover:bg-red-50",children:e.jsx(V,{className:"w-3 h-3"})})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-2 space-y-2 custom-scrollbar",children:[E.map(s=>e.jsxs("div",{onClick:()=>o(s),className:`flex items-center gap-2 p-2 rounded-lg cursor-pointer border transition-all relative group
                                ${a?.id===s.id?"bg-white border-indigo-500 shadow-md ring-1 ring-indigo-500":"bg-white border-slate-200 hover:border-indigo-300"}
                            `,children:[e.jsx("div",{className:"w-10 h-10 bg-slate-100 rounded overflow-hidden flex-shrink-0 border border-slate-100",children:s.status==="processing"?e.jsx("div",{className:"w-full h-full flex items-center justify-center text-indigo-500",children:e.jsx(B,{className:"w-3 h-3 animate-spin"})}):e.jsx("img",{src:s.processedUrl||s.originalUrl,className:"w-full h-full object-cover",alt:"thumb"})}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:`text-xs font-bold truncate ${a?.id===s.id?"text-indigo-700":"text-slate-700"}`,children:s.name}),e.jsxs("p",{className:"text-[9px] text-slate-400 flex gap-1 items-center mt-0.5",children:[s.settingsUsed.algorithm==="adaptive"?"自適應":"經典",s.settingsUsed.scaleMultiplier>1&&e.jsxs("span",{className:"bg-amber-100 text-amber-700 px-1 rounded",children:[s.settingsUsed.scaleMultiplier,"x"]})]})]}),e.jsx("button",{onClick:t=>v(s.id,t),className:"p-1 text-slate-300 hover:text-red-500 rounded opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx(F,{className:"w-3 h-3"})})]},s.id)),E.length===0&&e.jsx("div",{className:"text-center py-4 text-slate-300 text-xs",children:"暫無紀錄"})]})]})]}),e.jsx("div",{className:"flex-1 bg-slate-200/80 relative flex flex-col h-[55vh] md:h-full",children:a?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"absolute top-4 right-4 z-30 flex gap-2",children:[e.jsxs("div",{className:"bg-white/90 backdrop-blur shadow-sm rounded-lg p-1 flex gap-1 border border-slate-200",children:[e.jsx("button",{onClick:()=>C("original"),className:`p-1.5 rounded-md transition-all ${S==="original"?"bg-indigo-100 text-indigo-600":"text-slate-400 hover:text-slate-600 hover:bg-slate-100"}`,title:"僅原圖 (Original Only)",children:e.jsx(I,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>C("split"),className:`p-1.5 rounded-md transition-all ${S==="split"?"bg-indigo-100 text-indigo-600":"text-slate-400 hover:text-slate-600 hover:bg-slate-100"}`,title:"對比模式 (Split View)",children:e.jsx(W,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>C("processed"),className:`p-1.5 rounded-md transition-all ${S==="processed"?"bg-indigo-100 text-indigo-600":"text-slate-400 hover:text-slate-600 hover:bg-slate-100"}`,title:"僅成品 (Processed Only)",children:e.jsx(K,{className:"w-4 h-4"})})]}),e.jsx("div",{className:"w-px h-8 bg-slate-300 mx-1 self-center"}),e.jsxs("button",{onClick:()=>i(a),disabled:a.status!=="done",className:`px-4 py-2 rounded-full shadow-lg font-bold text-sm flex items-center gap-2 transition-transform active:scale-95
                                ${a.status==="done"?"bg-indigo-600 text-white hover:bg-indigo-700":"bg-slate-300 text-slate-500 cursor-not-allowed"}
                            `,children:[e.jsx(A,{className:"w-4 h-4"})," 下載成品"]})]}),e.jsx("div",{className:"flex-1 w-full h-full relative",children:a.status==="processing"?e.jsxs("div",{className:"absolute inset-0 flex flex-col items-center justify-center text-indigo-600",children:[e.jsx(B,{className:"w-10 h-10 animate-spin mb-3"}),e.jsx("p",{className:"font-bold",children:"正在處理..."})]}):a.status==="error"?e.jsx("div",{className:"absolute inset-0 flex flex-col items-center justify-center text-red-500",children:e.jsx("p",{children:"處理失敗"})}):e.jsx(ae,{originalUrl:a.originalUrl,processedUrl:a.processedUrl,settings:a.settingsUsed,viewMode:S})})]}):e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center text-slate-400",children:[e.jsx("div",{className:"p-6 bg-slate-100 rounded-full mb-4",children:e.jsx(_,{className:"w-10 h-10 text-slate-300"})}),e.jsx("p",{className:"font-bold",children:"請選擇或上傳一張圖片"}),e.jsx("p",{className:"text-sm mt-1",children:"左側歷史紀錄可切換檢視"})]})}),e.jsx("style",{children:`
            .custom-scrollbar::-webkit-scrollbar { width: 4px; }
            .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
            .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        `})]})};q.createRoot(document.getElementById("root")).render(e.jsx(r.StrictMode,{children:e.jsx(le,{})}));
